<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω chia ti·ªÅn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .form-check-inline {
            margin-right: 10px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <div class="row">
            <div class="col-12 col-md-3">
                <a href="history.html" class="btn btn-outline-secondary mb-3">üìú Xem l·ªãch s·ª≠ t√≠nh ti·ªÅn</a>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-6">
                <h2 class="mb-3">üë§ Danh s√°ch c√°c bro</h2>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="newPerson" class="form-control" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi m·ªõi">
                            <button class="btn btn-primary" id="addPerson">Th√™m ng∆∞·ªùi</button>
                        </div>
                        <ul class="list-group" id="personList"></ul>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <h2 class="mb-3">üí∏ Kho·∫£n chi</h2>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Ti√™u ƒë·ªÅ kho·∫£n chi</label>
                            <input type="text" class="form-control" id="expenseTitle" placeholder="VD: Ti·ªÅn ƒëi·ªán, n∆∞·ªõc...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ng∆∞·ªùi chi</label>
                            <select class="form-select" id="payerSelect"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë ti·ªÅn (VND)</label>
                            <input type="number" class="form-control" id="amount">
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label mb-0">Ng∆∞·ªùi c√πng chia</label>
                                <button class="btn btn-sm btn-outline-primary" type="button" id="checkAllBtn">Ch·ªçn t·∫•t c·∫£</button>
                            </div>
                            <div id="sharedWithCheckboxes" class="form-check"></div>
                        </div>
                        <button class="btn btn-success" id="addExpense">Th√™m kho·∫£n chi</button>
                    </div>
                </div>
            </div>
        </div>
        <h2 class="mb-3">üìú Danh s√°ch kho·∫£n chi</h2>
        <div class="card mb-4">
            <div class="card-body" id="expenseList"></div>
        </div>
        <button class="btn btn-primary mb-3" id="calculate">T√≠nh chia</button>
        <div id="result" class="card" style="display:none;">
            <div class="card-body"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
        // Kh·ªüi t·∫°o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDxRarjAaLRVTkMSnaUdv1NsoZam8b3rlc",
            authDomain: "money-7965b.firebaseapp.com",
            projectId: "money-7965b",
            storageBucket: "money-7965b.firebasestorage.app",
            messagingSenderId: "117194635590",
            appId: "1:117194635590:web:6d911955d6257e16760d47",
            measurementId: "G-Y676HMF04H"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>


    <!-- Bootstrap JS (optional for components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).on('click', '#checkAllBtn', function () {
            const checkboxes = $('#sharedWithCheckboxes input[type="checkbox"]');
            const allChecked = checkboxes.length === checkboxes.filter(':checked').length;
            checkboxes.prop('checked', !allChecked);
            $(this).text(allChecked ? 'Ch·ªçn t·∫•t c·∫£' : 'B·ªè ch·ªçn t·∫•t c·∫£');
        });
        let people = [];
        let expenses = [];

        function renderPeople() {
            $('#payerSelect').html(people.map(p => `<option value="${p}">${p}</option>`));
            $('#sharedWithCheckboxes').html(people.map(p => `
                    <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="${p}" id="share-${p}">
                    <label class="form-check-label" for="share-${p}">${p}</label>
                    </div>
                `).join(''));

            $('#personList').html(people.map(p => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${p}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary editPerson" data-name="${p}">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger deletePerson" data-name="${p}">‚ùå</button>
                    </div>
                    </li>
                `).join(''));
        }

        $('#addPerson').on('click', function () {
            const name = $('#newPerson').val().trim();
            if (name && !people.includes(name)) {
                people.push(name);
                $('#newPerson').val('');
                renderPeople();
            }
        });

        $('#personList').on('click', '.deletePerson', function () {
            const name = $(this).data('name');
            if (confirm(`X√≥a ${name}?`)) {
                people = people.filter(p => p !== name);
                expenses = expenses.filter(e => e.payer !== name && !e.sharedWith.includes(name));
                renderPeople();
                renderExpenses();
            }
        });

        $('#personList').on('click', '.editPerson', function () {
            const oldName = $(this).data('name');
            const newName = prompt("S·ª≠a t√™n ng∆∞·ªùi d√πng:", oldName);
            if (newName && newName.trim() !== "" && !people.includes(newName.trim())) {
                const trimmedName = newName.trim();
                people = people.map(p => (p === oldName ? trimmedName : p));
                expenses = expenses.map(e => ({
                    title: e.title,
                    payer: e.payer === oldName ? trimmedName : e.payer,
                    amount: e.amount,
                    sharedWith: e.sharedWith.map(p => p === oldName ? trimmedName : p)
                }));
                renderPeople();
                renderExpenses();
            } else if (newName && people.includes(newName.trim())) {
                alert("T√™n ƒë√£ t·ªìn t·∫°i!");
            }
        });

        $('#addExpense').on('click', function () {
            const title = $('#expenseTitle').val().trim();
            const payer = $('#payerSelect').val();
            const amount = parseFloat($('#amount').val()) || 0;
            const sharedWith = $('#sharedWithCheckboxes input:checked').map(function () {
                return $(this).val();
            }).get();

            if (title && payer && amount > 0 && sharedWith.length > 0) {
                expenses.push({ title, payer, amount, sharedWith });
                $('#expenseTitle').val('');
                $('#amount').val('');
                $('#sharedWithCheckboxes input').prop('checked', false);
                renderExpenses();
            } else {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.");
            }
        });

        function renderExpenses() {
            $('#expenseList').html(expenses.map((e, i) => `
                    <div class="mb-2 border-bottom pb-2">
                    <strong>${e.title}</strong>: ${e.payer} chi <strong>${e.amount.toLocaleString()} VND</strong> cho [${e.sharedWith.join(', ')}]
                    <button class="btn btn-sm btn-outline-danger float-end deleteExpense" data-index="${i}">‚ùå</button>
                    </div>
                `).join(''));
        }

        $('#expenseList').on('click', '.deleteExpense', function () {
            const i = $(this).data('index');
            expenses.splice(i, 1);
            renderExpenses();
        });

        $('#calculate').on('click', function () {
            const paid = {}, owed = {};
            const allPeople = [...new Set(people)];
            expenses.forEach(e => {
                paid[e.payer] = (paid[e.payer] || 0) + e.amount;
                const share = e.amount / e.sharedWith.length;
                e.sharedWith.forEach(p => {
                    owed[p] = (owed[p] || 0) + share;
                });
            });

            let result = `<h5 class="mb-3">Chi ti·∫øt t·ª´ng kho·∫£n</h5>`;
            expenses.forEach(e => {
                const share = Math.round(e.amount / e.sharedWith.length);
                result += `<p><strong>${e.title}</strong>: ${e.payer} chi ${e.amount.toLocaleString()} VND cho ${e.sharedWith.length} ng∆∞·ªùi (${e.sharedWith.join(', ')}), m·ªói ng∆∞·ªùi tr·∫£ ${share.toLocaleString()} VND</p>`;
            });

            result += `<h5 class="mt-4">T·ªïng k·∫øt</h5><table class="table table-bordered mt-2">
                            <thead><tr><th>Ng∆∞·ªùi</th><th>ƒê√£ chi</th><th>Ph·∫£i tr·∫£</th><th>Ch√™nh l·ªách</th></tr></thead><tbody>`;

            allPeople.forEach(p => {
                const chi = Math.round(paid[p] || 0);
                const no = Math.round(owed[p] || 0);
                const diff = chi - no;
                let msg = diff === 0 ? "0" : (diff > 0 ? `Nh·∫≠n l·∫°i ${diff.toLocaleString()} VND` : `Tr·∫£ th√™m ${Math.abs(diff).toLocaleString()} VND`);
                result += `<tr><td>${p}</td><td>${chi.toLocaleString()}</td><td>${no.toLocaleString()}</td><td>${msg}</td></tr>`;
            });

            result += `</tbody></table>`;
            $('#result .card-body').html(result);
            $('#result').show();

            // save to firestore
            const now = new Date().toISOString();
            db.collection("chiaTienResults").add({
                timestamp: now,
                people: people,
                expenses: expenses,
                summaryHTML: $('#result .card-body').html()
            })
            .then(() => {
                console.log("Saved!");
            })
            .catch((error) => {
                console.error("Error:", error);
            });
        });

        // Sample data
        people = ["ƒê·ª©c", "Huy", "D√¢n", "T√∫", "Tr∆∞·ªùng", "Th∆∞∆°ng", "Ch√¢m", "VƒÉn", "Qu·ª≥nh"];
        renderPeople();
    </script>
</body>

</html>